pipeline {
    agent any

    triggers {
        githubPush()
    }
    stages {
        stage('Checkout código') {
            steps {
                checkout scmGit(branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/AppBlitz/backend_sofware_III.git']])
            }
        }
        stage('Compilar aplicación') {
            steps {
                sh "${CNS}"
            }
        }
        stage('Ejecutar pruebas') {
            steps {
                sh './gradlew test'
            }
        }
        stage('install testRail') {
            steps {
                sh 'pip install trcli'
            }
        }
        stage('Subir resultados a TestRail') {
            steps {
                sh '''
                export PATH=$PATH:/var/lib/jenkins/.local/bin
                trcli -y \
                 -h "${HOST}" \
                  --project "${PROJECT}" \
                  --username "${USERNAME}" \
                  --password "${PASSWORD}" \
                  parse_junit \
                  --title "JUnit5 Automated Test Run" \
                  -f "${DIRECTORY}"
                '''
            }
        }
    }
}

